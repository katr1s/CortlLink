---
import Navigation from "../../components/Navigation.astro";
import Select from "../../components/selectplatform.astro";
import Layout from "../../layouts/Layout.astro";
import "../../css/collection.css";

export const prerender = false;

const { collection } = Astro.params;
---

<Layout title={collection}>
  <div class="background"></div>
  <Navigation />

  <div class="link show">
    <form class="form" action="submit">
      <div class="box">
        <a class="refresh">Back</a>
        <h2>Save URL</h2>
        <p class="menssage">
          <span>Note:</span> Anchor text (link text) should not begin with a numeral
        </p>
        <label for="Name">Title</label>
        <input
          type="text"
          id="Name"
          class="Name"
          maxlength="30"
          required
          placeholder="Article"
        />
        <label for="Description">Description</label>
        <textarea id="Description" class="Description" maxlength="140" required
        ></textarea>
        <label for="Url">Url</label>
        <input
          type="text"
          class="Url"
          id="Url"
          required
          placeholder="cortlink.live"
        />
        <input
          type="text"
          style="display: none;"
          value={collection}
          class="collection"
        />
        <button class="mobile-show">Save</button>
      </div>
      <div class="box box-mobile">
        <Select />
        <button class="mobile-up">Save</button>

      </div>
    </form>
  </div>

  <div class="hero">
    <div class="button">
      <div class="back">
        <a href="/Folders">Folder</a>
        <h2>/{collection}</h2>
      </div>
      <button class="CreateLink">New</button>
    </div>
    <div class="content"></div>
  </div>

  <script>
    import { onAuthStateChanged } from "firebase/auth";
    import { auth, db, unsubcribe } from "../../firebase";
    import { doc, getDoc, setDoc } from "firebase/firestore";

    // DOM elements
    const form = document.querySelector(".form");
    const Link = document.querySelector(".link");
    const menssage = document.querySelector(".menssage");
    const CreateLink = document.querySelector(".CreateLink");
    const collectionInput = document.querySelector(".collection");
    const container = document.querySelector(".content");
    const Name = document.querySelector(".Name");
    const Description = document.querySelector(".Description");
    const URL = document.querySelector(".Url");
    const platformIconImg = document.getElementById("platformIcon");

    const apiUrl = import.meta.env.PUBLIC_API_URL;
    const cortlink = "cortlink.live";

    const backCollection = document
      .querySelector(".refresh")
      ?.addEventListener("click", () => {
        window.location.href = `/Folder/${collectionInput.value}`;
      });

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = `/`;
        return;
      }

      const docRef = doc(db, "users", user.uid);
      const docSnap = await getDoc(docRef);
      const data = docSnap.data();

      const aliasCollection = collectionInput.value
        .trim()
        .replace(/\s+/g, "-")
        .toLowerCase();

      unsubcribe(user.uid, aliasCollection, container);

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        try {
          if (!URL.value.trim().startsWith("https://")) {
            alert("The URL must start with https://");
            return;
          }

          const rawAlias = Name.value.trim().toLowerCase();
          const safeAlias = rawAlias
            .replace(/\s+/g, "-")
            .replace(/[^a-z0-9-]/g, "");

          const alias = `${safeAlias}-${aliasCollection.slice(0, 2)}`;

          // ✅ LEER RADIO AQUÍ (CORRECTO)
          const selectedPlatform = document.querySelector(
            'input[name="platform"]:checked'
          );

          if (!selectedPlatform) {
            alert("Selecciona una plataforma");
            return;
          }

          const platformName = selectedPlatform.value;
          const platformIcon = selectedPlatform.dataset.icon;

          const folderRef = doc(db, "users", user.uid, aliasCollection, alias);

          const validate = await getDoc(folderRef);

          if (validate.exists()) {
            menssage.textContent = "URL exist";
            return;
          }

          await setDoc(folderRef, {
            userId: user.uid,
            Name: Name.value,
            Alias: alias,
            username: data.username,
            Description: Description.value,
            url: `${cortlink}/${data.username}/${alias}`,
            Folder: aliasCollection,
            platform: platformIcon,
            platformName: platformName,
          });

          const newUrl = {
            alias: alias,
            user: data.username,
            url: URL.value,
          };

          await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(newUrl),
          });

          // Reset
          Name.value = "";
          Description.value = "";
          URL.value = "";
          menssage.textContent = "";
          Link.classList.add("show");

          window.location.href = `/Folder/${collectionInput.value}`;
        } catch (error) {
          console.error(error);
        }
      });
    });

    CreateLink.addEventListener("click", () => {
      Link.classList.remove("show");
    });
  </script>
</Layout>
