---
import Layout from "../layouts/Layout.astro";
import "../css/create-user.css"
---

<Layout>
  <div class="hero">
    <div class="background"></div>
    <div class="content">
      <h1 class="title"></h1>
      <div class="card">
        <img class="user-photo" />
        <form id="create-user-form">
          <label for="username">Username</label>
          <input type="text" id="username" />
          <button>Create user</button>
        </form>
      </div>
    </div>
  </div>

  

  <script>
    import { auth, db } from "../firebase";
    import { onAuthStateChanged } from "firebase/auth";
    // Añadimos collection, query, where y getDocs
    import {
      doc,
      setDoc,
      collection,
      query,
      where,
      getDocs,
    } from "firebase/firestore";

    onAuthStateChanged(auth, async (user) => {
      if (!user) return; // Seguridad: si no hay usuario, no ejecutar

      const photo = document.querySelector(".user-photo");
      const titlePage = document.querySelector(".title");
      const form = document.getElementById("create-user-form");
      const usernameInput = document.getElementById("username");

      photo.src = user?.photoURL;
      titlePage.textContent = user?.displayName;

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const chosenUsername = usernameInput.value.trim();

        if (!chosenUsername) {
          alert("Por favor ingresa un nombre de usuario");
          return;
        }

        try {
          // --- VALIDACIÓN DE USERNAME ---
          // 1. Referencia a la colección
          const usersRef = collection(db, "users");

          // 2. Crear consulta para ver si el username ya existe
          const q = query(usersRef, where("username", "==", chosenUsername));

          // 3. Ejecutar consulta
          const querySnapshot = await getDocs(q);

          // 4. Verificar si hubo resultados
          if (!querySnapshot.empty) {
            alert("Este nombre de usuario ya está en uso. Elige otro.");
            return; // Detenemos la ejecución aquí
          }

          // --- SI NO EXISTE, PROCEDEMOS A CREARLO ---
          await setDoc(doc(db, "users", user.uid), {
            uid: user.uid,
            email: user.email,
            name: user.displayName,
            username: chosenUsername,
            photoURL: user.photoURL,
            createdAt: new Date(),
            CreateCollections: 0,
            collection: 10,
          });

          window.location.href = "/Folders";
        } catch (error) {
          console.error("Error creando el usuario:", error);
          alert("Ocurrió un error al procesar tu solicitud.");
        }
      });
    });
  </script>
</Layout>
